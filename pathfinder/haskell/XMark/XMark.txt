
-- Q1.Return the name of the person with ID `person0'
--    registered in North America.

FOR    $b IN document("auction.xml")/site/people/person[@id="person0"]
RETURN $b/name/text()

-- Q2. Return the initial increases of all open auctions.

FOR $b IN document("auction.xml")/site/open_auctions/open_auction
RETURN <increase> $b/bidder[1]/increase/text() </increase>

-- Q3. Return the IDs of all open auctions whose current
--     increase is at least twice as high as the initial increase.

FOR    $b IN document("auction.xml")/site/open_auctions/open_auction
WHERE  $b/bidder[0]/increase/text() *2 <= $b/bidder[last()]/increase/text()
RETURN <increase first=$b/bidder[0]/increase/text()
                 last=$b/bidder[last()]/increase/text()/>

-- Q4. List the reserves of those open auctions where a
--     certain person issued a bid before another person.

FOR    $b IN document("auction.xml")/site/open_auctions/open_auction
WHERE  $b/bidder/personref[@person="person18829"] BEFORE
       $b/bidder/personref[@person="person10487"]
RETURN <history> $b/reserve/text() </history>

-- Q5.  How many sold items cost more than 40?

COUNT(FOR $i IN document("auction.xml")/site/closed_auctions/closed_auction
        WHERE  $i/price/text() >= 40 
        RETURN $i/price)

-- Q6. How many items are listed on all continents?

FOR    $b IN document("auction.xml")/site/regions
RETURN COUNT ($b//item)

-- Q7. How many pieces of prose are in our database?

FOR $p IN document("auction.xml")/site
RETURN count($p//description) + count($p//annotation) + count($p//email);

-- Q8. List the names of persons and the number of items they bought.
--     (joins person, closed\_auction)}

FOR $p IN document("auction.xml")/site/people/person
LET $a := FOR $t IN document("auction.xml")/site/closed_auctions/closed_auction
             WHERE $t/buyer/@person = $p/@id
             RETURN $t
RETURN <item person=$p/name/text()> COUNT ($a) </item>

-- Q9. List the names of persons and the names of the items they bought
--     in Europe.  (joins person, closed\_auction, item)}

FOR $p IN document("auction.xml")/site/people/person
LET $a := FOR $t IN document("auction.xml")/site/closed_auctions/closed_auction
          LET $n := FOR $t2 IN document("auction.xml")/site/regions/europe/item
                       WHERE  $t/itemref/@item = $t2/@id
                       RETURN $t2
             WHERE $p/@id = $t/buyer/@person
             RETURN <item> $n/name/text() </item>
RETURN <person name=$p/name/text()> $a </person>

-- Q10. List all persons according to their interest;
--      use French markup in the result.

FOR $i IN DISTINCT
          document("auction.xml")/site/people/person/profile/interest/@category
LET $p := FOR    $t IN document("auction.xml")/site/people/person
          WHERE  $t/profile/interest/@category = $i
            RETURN <personne>
                <statistiques>
                        <sexe> $t/gender/text() </sexe>,
                        <age> $t/age/text() </age>,
                        <education> $t/education/text()</education>,
                        <revenu> $t/income/text() </revenu>
                </statistiques>,
                <coordonnees>
                        <nom> $t/name/text() </nom>,
                        <rue> $t/street/text() </rue>,
                        <ville> $t/city/text() </ville>,
                        <pays> $t/country/text() </pays>,
                        <reseau>
                                <courrier> $t/email/text() </courrier>,
                                <pagePerso> $t/homepage/text()</pagePerso>
                        </reseau>,
                </coordonnees>
                <cartePaiement> $t/creditcard/text()</cartePaiement>    
              </personne>
RETURN <categorie>
        <id> $i </id>,
        $p
      </categorie>

-- Q11. For each person, list the number of items currently on sale whose
--      price does not exceed 0.02% of the person's income.

FOR $p IN document("auction.xml")/site/people/person
LET $l := FOR $i IN document("auction.xml")/site/open_auctions/open_auction/initial
          WHERE $p/profile/@income > (5000 * $i/text())
          RETURN $i
RETURN <items name=$p/name/text()> COUNT ($l) </items>

-- Q12.  For each richer-than-average person, list the number of items 
--       currently on sale whose price does not exceed 0.02% of the 
--       person's income.

FOR $p IN document("auction.xml")/site/people/person
LET $l := FOR $i IN document("auction.xml")/site/open_auctions/open_auction/initial
          WHERE $p/profile/@income > (5000 * $i/text())
          RETURN $i
WHERE  $p/profile/@income > 50000
RETURN <items person=$p/name/income/text()> COUNT ($l) </person>

-- Q13. List the names of items registered in Australia along with 
--      their descriptions.

FOR $i IN document("auction.xml")/site/regions/australia/item
RETURN <item name=$i/name/text()> $i/description </item>

-- Q14. Return the names of all items whose description contains the 
--      word `gold'.

FOR $i IN document("auction.xml")/site//item
WHERE CONTAINS ($i/description,"gold")
RETURN $i/name/text()

-- Q15. Print the keywords in emphasis in annotations of closed auctions.

FOR $a IN document("auction.xml")/site/closed_auctions/closed_auction/annotation/\
            description/parlist/listitem/parlist/listitem/text/emph/keyword/text()
RETURN <text> $a <text>

-- Q16. Return the IDs of those auctions
--      that have one or more keywords in emphasis. (cf. Q15)

FOR $a IN document("auction.xml")/site/closed_auctions/closed_auction
WHERE NOT EMPTY ($a/annotation/description/parlist/listitem/parlist/\
                     listitem/text/emph/keyword/text())
RETURN <person id=$a/seller/@person />

-- Q17. Which persons don't have a homepage?

FOR    $p IN document("auction.xml")/site/people/person
WHERE  EMPTY($p/homepage/text())
RETURN <person name=$p/name/text()/>

-- Q18.Convert the currency of the reserve of all open auctions to 
--     another currency.

FUNCTION CONVERT ($v)
{
  RETURN 2.20371 * $v -- convert Dfl to Euro
}

FOR    $i IN document("auction.xml")/site/open_auctions/open_auction/
RETURN CONVERT($i/reserve/text())

-- Q19. Give an alphabetically ordered list of all
--      items along with their location.

FOR    $b IN document("auction.xml")/site/regions//item
LET    $k := $b/name/text()
RETURN <item name=$k> $b/location/text() </item>
SORTBY (.)

-- Q20. Group customers by their
--      income and output the cardinality of each group.

<result>
 <preferred>
  COUNT (document("auction.xml")/site/people/person/profile[@income >= 100000])
 </preferred>,
 <standard>
  COUNT (document("auction.xml")/site/people/person/profile[@income < 100000
                                                        and @income >= 30000])
 </standard>,
 <challenge> 
  COUNT (document("auction.xml")/site/people/person/profile[@income < 30000])
 </challenge>,
 <na>
  COUNT (FOR    $p in document("auction.xml")/site/people/person
         WHERE  EMPTY($p/@income)
         RETURN $p)
 </na>
</result>
