@f sql_changeset
@c

#include "sql_catalog.h"

void
cs_init(changeset * cs, fdestroy destroy)
{
	cs->destroy = destroy;
	cs->set = NULL;
	cs->dset = NULL;
	cs->nelm = NULL;
}

void
cs_destroy(changeset * cs)
{
	if (cs->set)
		list_destroy(cs->set);
	if (cs->dset)
		list_destroy(cs->dset);
}

void
cs_add(changeset * cs, void *elm, int flag)
{
	if (!cs->set)
		cs->set = list_create(cs->destroy);
	list_append(cs->set, elm);
	if (flag == TR_NEW && !cs->nelm)
		cs->nelm = cs->set->t;
}

void
cs_del(changeset * cs, node *elm, int flag)
{
	if (flag == TR_NEW) {	/* remove just added */
		if (cs->nelm == elm)
			cs->nelm = elm->next;
		list_remove_node(cs->set, elm);
	} else {
		if (!cs->dset)
			cs->dset = list_create(cs->destroy);
		list_move_data(cs->set, cs->dset, elm->data);
	}
}

int
cs_size(changeset * cs)
{
	if (cs->set)
		return list_length(cs->set);
	return 0;
}

node *
cs_first_node(changeset * cs)
{
	return cs->set->h;
}
