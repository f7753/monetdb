# a test checking BAT reference counting under various situations
function steal(bb:bat[:any$1,:any$2]) :bat[:any$1,:any$2];
	i:= getLRefCount(bb);
	printf("enter function refcount =%d[2]\n",i);

	loc:= bb;
	i:= getLRefCount(bb);
	printf("local in function refcount =%d[3]\n",i);

	return bb;
end steal; 

	b:= new(:int,:str);
	i:= getLRefCount(b);
	printf("refcount =%d[1]\n",i);	

	insert(b,1,"bat B");
	print(b);
	i:= getLRefCount(b);
	printf("refcount =%d[1]\n",i);

	#handle an alias
	b2:= b;			
	i:= getLRefCount(b);
	printf("after assignment refcount =%d[2]\n",i);

	#re-use a bat variable
	b3:= b;			
	i:= getLRefCount(b);
	printf("after 2nd assignment refcount =%d[3]\n",i);

	#re-use a bat variable
	b3:= new(:int,:str);			
	i:= getLRefCount(b);
	printf("after 3rd assignment refcount =%d[2]\n",i);
	i:= getLRefCount(b3);
	printf("assignment refcount =%d[1]\n",i);

	#re-use a bat variable
	b4:= select(b,"bat B","bat B");
	print(b4);
	i:= getLRefCount(b);
	printf("after 4rd assignment refcount =%d[2]\n",i);

	# remove by assignment
	b2:= b3;
	i:= getLRefCount(b);
	printf("after 5rd assignment refcount =%d[1]\n",i);

	printf("call function\n");
	d:= steal(b);
	i:= getLRefCount(b);
	printf("return from function refcount =%d[2]\n",i);

	printf("check self replacement\n");
	i:= getLRefCount(b);
	b:= steal(b);
	j:= getLRefCount(b);
	print(i); print(j);

	z:= bbp.getRefCount();
	zl:= bbp.getLRefCount();
	zn:= bbp.getNames();
	print(zn,z,zl);
