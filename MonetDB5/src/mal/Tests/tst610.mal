#this test is used to monitor reference count setting
#create a persistent bat and destroy it in the next session
function refs():void;
    g:=bbp.getNames();
    gr:=bbp.getRefCount();
    gl:=bbp.getLRefCount();
    print(g,gr,gl);
end refs;

b:= new(:int,:int);
#refs();
insert(b,23,32);
#refs();
setName(b,"tasks");
#refs();
setPersistent(b);
#refs();
# it is committed 
print("open box");
bbp.open();
refs();
t:= bbp.bind("tasks");
print(t);
bbp.release(t);
refs();
print(t);
catch MALexception;
print("BAT was released");
exit MALexception;
# the bat is still visible, because the destroy only
# marks it for deletion at the end of session or
# when the reference counters drop to zero
t:= bind("tasks");
refs();
# to really remove, we get rid of the current
# references as well
bbp.destroy(t,true);
refs();
print(t);
catch MALexception;
print("BAT was destroyed");
exit MALexception;
z:=bind("tasks");
print(z);
#it is not in the box anymore either
catch MALexception;
print("BAT was removed from the box");
exit MALexception;
