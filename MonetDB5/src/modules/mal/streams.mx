@f streams
@a Niels Nes
@* An simple interface to streams 
This interface can be used to open 'non compressed, gzipped, bz2zipped' 
data files. It encapsulates the corresponding library managed in 
.../stream.

@mal
atom stream : ptr;

module streams;

command open_rstream( filename:str ) : stream = stream_open_rstream
	comment "open a file stream for reading";
command open_wstream( filename:str ) : stream = stream_open_wstream
	comment "open a file stream for writing";
command open_rastream( filename:str ) : stream = stream_open_rastream 
	comment "open ascii file stream for reading";
command open_wastream( filename:str ) : stream = stream_open_wastream 
	comment "open ascii file stream for writing";

command socket_rstream( socket:int, name:str ) : stream = stream_socket_rstream
	comment "open a socket stream for reading";
command socket_wstream( socket:int, name:str ) : stream = stream_socket_wstream
	comment "open a socket stream for writing";
command socket_rastream( socket:int, name:str ) : stream = stream_socket_rastream
	comment "open ascii socket stream for reading";
command socket_wastream( socket:int, name:str ) : stream = stream_socket_wastream
	comment "open ascii socket stream for writing";

command block_stream( s:stream ) : stream = open_block_stream
	comment "open a block based stream";

command writeStr( s:stream, data:str ):void = stream_write_string
	comment "write data on the stream";
command writeInt( s:stream, data:int ):void = stream_write_int
	comment "write data on the stream";
command readStr( s:stream):str = stream_read_str
	comment "read string data from the stream";
command readInt( s:stream):str = stream_read_int
	comment "read integer data from the stream";


command flush( s:stream ) = stream_flush
	comment "flush the stream";

command close( s:stream ) = stream_close_stream 
	"close and destroy the stream s";

@h

/*
 * The contents of this file are subject to the Monet Public
 * License Version 1.1 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of
 * the License at 
 * http://www.monetsolutions.com/Download/Licensing/MonetPL-1.1.html
 * 
 * Software distributed under the License is distributed on an "AS
 * IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
 * implied. See the License for the specific language governing
 * rights and limitations under the License.
 * 
 * The Original Code is the Monet Database System.
 * 
 * The Initial Developer of the Original Code is CWI.
 * Portions created by CWI are Copyright (C) 1997-2002 CWI.  
 * All Rights Reserved.
 * 
 * Contributor(s): Niels Nes <Niels.Nes@cwi.nl>
 */

#ifndef _STREAMS_H_
#define _STREAMS_H_

#include "gdk.h"
#include <blob.h>
#include <io.h>

#endif /*_STREAMS_H_*/
@c
#include "streams.h"
#include "mal_function.h"


@-
@= open_stream
str stream_open_@1( stream *S, str filename ){
	stream *s;

	if ((s = open_@1( filename )) == NULL || s->errnr){
		if (s) s->destroy(s);
		return throwMessage("stream","Could not open file\n");
 	} else {
		*(stream**)S = s;
 		return MAL_SUCCEED;
 	}
 }
@c
@:open_stream(rstream)@
@:open_stream(wstream)@
@:open_stream(rastream)@
@:open_stream(wastream)@

@-
@= open_socket
str stream_socket_@1( stream *S, int *socket, str name ){
	stream *s;

	if ((s = socket_@1( *socket, name )) == NULL || s->errnr){
		if (s) s->destroy(s);
		return throwMessage("streams.socket_rstream","failed"); 
	} else {
		*(stream**)S = s;
		return MAL_SUCCEED;
 	}
 }
@c
@:open_socket(rstream)@
@:open_socket(wstream)@
@:open_socket(rastream)@
@:open_socket(wastream)@

str stream_write_string( stream *S, str *data ){
	stream *s = *(stream**)S;
	s->write( s, *data, 1, strlen(*data));
	return MAL_SUCCEED;
}
str stream_write_int( stream *S, int *data ){
	stream *s = *(stream**)S;
	stream_writeInt(s,*data);
	return MAL_SUCCEED;
}
#define CHUNK (64*1024)
str stream_read_str( str *res,stream *S){
	stream *s = *(stream**)S;
        size_t len = 0;
        size_t size = CHUNK + 1;
        char *buf = GDKmalloc(size), *start = buf;

        while ((len = s->read(s, start, 1, CHUNK)) == CHUNK){
                size += CHUNK;
                buf = GDKrealloc(buf, size);
                start = buf + size - CHUNK - 1;
                *start = '\0';
        }
        start += len;
        *start = '\0';
        *res = buf;
	return MAL_SUCCEED;
}
str stream_read_int( int *data, stream *S){
	stream *s = *(stream**)S;
	stream_readInt(s,data);
	return MAL_SUCCEED;
}

str stream_flush( stream *S ){
	stream *s = *(stream**)S;
	s->flush( s );
	return MAL_SUCCEED;
}

str stream_close_stream( stream *S ){
	stream *s = *(stream**)S;
	s->close( s );
	s->destroy( s );
	return MAL_SUCCEED;
}

str open_block_stream( stream *S, stream *is ){
	if ((*(stream**)S = block_stream( *(stream**)is )) == NULL){
		return throwMessage("streams.block_stream","failed"); 
	} else {
		return MAL_SUCCEED;
	}
}
